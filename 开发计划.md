# 投资管理系统 - 开发计划

## 核心设计原则

* **个人使用**：单用户无需身份认证
* **轻量级**：最小依赖，快速启动
* **Vercel部署**：充分利用serverless特性
* **易开发维护**：代码结构简单清晰
* **学习成本低**：采用主流技术栈

## 技术架构调整

### 数据库方案：SQLite + Better-SQLite3

```
优势：
✅ 文件数据库，零配置
✅ Better-SQLite3 同步操作，代码简单
✅ Vercel Edge Runtime 支持
✅ 个人使用性能充足
✅ 数据文件可直接备份

注意事项：
⚠️ Vercel 无状态环境，需考虑数据持久化
💡 建议：使用 Vercel KV 或定期备份到GitHub
```

### 技术栈

* **前端**: Next.js 14 (App Router)
* **数据库**: SQLite + Better-SQLite3
* **UI**: TailwindCSS + shadcn/ui
* **图表**: Recharts
* **部署**: Vercel

## 数据结构

```sql
-- 项目表
CREATE TABLE projects (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  项目名称 TEXT NOT NULL,
  项目代号 TEXT,
  交易类型 TEXT CHECK(状态 IN ('做多', '做空')),
  成本价 REAL,
  当前价 REAL,
  股数 INTEGER,
  仓位 REAL,
  成本金额 REAL,
  当前金额 REAL,
  盈亏金额 REAL,
  项目盈亏率 REAL,
  总盈亏率 REAL,
  状态 TEXT CHECK(状态 IN ('进行', '完成')),
  创建时间 DATETIME DEFAULT CURRENT_TIMESTAMP,
  完成时间 DATETIME
);

-- 交易表
CREATE TABLE transactions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  项目ID INTEGER,
  项目名称 TEXT,
  状态 TEXT CHECK(状态 IN ('计划', '完成')),
  交易名称 TEXT,
  交易类型 TEXT CHECK(状态 IN ('做多', '做空', '多头平仓', '空头平仓')),
  警告方向 TEXT CHECK(状态 IN ('向上', '向下')),
  距离 REAL,
  交易价 REAL,
  股数 INTEGER,
  仓位 REAL,
  交易金额 REAL,
  创建时间 DATETIME DEFAULT CURRENT_TIMESTAMP,
  交易时间 DATETIME,
  FOREIGN KEY (项目ID) REFERENCES projects(id)
);

-- 总览表
CREATE TABLE overview (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  总金额 REAL,
  成本金额 REAL,
  持仓金额 REAL,
  盈亏金额 REAL,
  盈亏率 REAL,
  仓位 REAL,
  更新时间 DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 项目结构

```
/invest-manager
├── app/
│   ├── api/
│   │   ├── plans/
│   │   ├── projects/
│   │   ├── transactions/
│   │   ├── overview/
│   │   └── test/            # 测试API页面
│   ├── dashboard/           # 总览页
│   ├── plans/              # 计划页
│   ├── projects/           # 项目页
│   ├── transactions/       # 交易页
│   ├── funds/
│   └── statistics/         # 统计页
├── lib/
│   ├── db.ts              # SQLite 连接和初始化
│   ├── schema.sql         # 数据库Schema
│   ├── calculations.ts    # 计算逻辑
│   └── utils.ts           # 工具函数
├── components/
│   ├── ui/                # shadcn/ui 组件
│   ├── charts/            # 图表组件
│   ├── forms/             # 表单组件
│   ├── plans/             # 计划页面组件
│   ├── projects/          # 项目页面组件
│   └── editable/          # 可编辑组件
└── data/
    └── investment.db      # SQLite 数据库文件
```

## 页面设计规范

### 要求
- 所有页的左上角相同位置都有一个按钮“隐藏”，点击变为“显示”。可隐藏数值（股数、成本金额、盈亏金额、交易金额、当前金额，总金额、持仓金额），变为****

### 计划页 (/plans)

#### 功能描述
- 显示所有状态为"进行"的项目的"计划"状态交易
- 相同项目的交易分组显示，共享背景框
- 支持行内编辑，实时计算相关字段

#### 布局设计

| 项目名称 | 交易名称 | 交易类型 | 警告方向 | 距离 | 当前价 | 交易价 | 股数 | 仓位 | 交易金额 | 创建时间 |
|-----|----------|---------|----------|------|--------|------|------|-----|--------|---------|
| 泡泡玛特 | 第一手   | 做多     | 向上     | 20   | 1000 | 1200   | 80  | 120 | 120000 | 2025-09-17 |
| 泡泡玛特 | 最后一手 | 多头平仓 | 向上     | 20   | 1000 | 1200   | 100  | 20  | 120000 | 2025-09-17 |
|  |  |  |  |  |  |  |  |  |  |
| 安克创新 | 第一手   | 做多     | 向上     | 20   | 1100 | 1200   | 1000 | 120 | 120000 | 2025-09-17 |
| 安克创新 | 第一手   | 多头平仓 | 向上     | 20   | 1100 | 1200   | 60   | 10  | 120000 | 2025-09-17 |

#### 可编辑字段及计算逻辑
- **交易名称、交易类型、创建时间**：直接编辑
- **警告方向**：改变时自动计算距离
- **距离**：改变时自动计算交易价
- **当前价**：改变时自动计算距离
- **交易价**：改变时自动计算距离、股数
- **股数**：改变时自动计算仓位、交易金额
- **仓位**：改变时自动计算股数、交易金额
- **交易金额**：改变时自动计算股数、仓位

### 项目页 (/projects)

#### 功能描述
- 显示所有项目的详细信息
- 每个项目显示其关联的所有交易
- 支持项目和交易信息的行内编辑

#### 布局设计

[项目A背景框]

| 项目名称       | 项目代号 | 交易类型 | 成本价  | 当前价 | 股数 | 仓位 | 成本金额  | 当前金额 | 盈亏金额 | 项目盈亏率 | 总盈亏率 | 状态 |
|----------------|----------|----------|---------|--------|------|------|-----------|----------|----------|------------|--------------------|----------|
| 泡泡玛特       | 9992     | 做多     | -6100   | 1200   | 10   | 12   | -61000    | 12000    | 73000    | 0          | 73         | 进行 |

| 状态 | 交易名称 | 交易类型 | 警告方向 | 距离 | 交易价 | 股数 | 仓位 | 交易金额 | 创建时间 |
|-----|----------|---------|----------|------|--------|------|-----|--------|---------|
| 进行 | 第一手   | 做多     | 向上     | 20   | 1200   | 80  | 120 | 120000 | 2025-09-17 |
| 进行 | 最后一手 | 多头平仓 | 向上     | 20   | 1200   | 100  | 20  | 120000 | 2025-09-17 |
|  |  |  |  |  |  |  |  |  |  |
| 完成 | 第一手   | 做多     | 向上     | 20   | 1200   | 1000 | 120 | 120000 | 2025-09-17 |
| 完成 | 第一手   | 多头平仓 | 向上     | 20   | 1200   | 60   | 10  | 120000 | 2025-09-17 |

[项目B背景框]
| 项目名称       | 项目代号 | 交易类型 | 成本价  | 当前价 | 股数 | 仓位 | 成本金额  | 当前金额 | 盈亏金额 | 项目盈亏率 | 总盈亏率 | 状态 |
|----------------|----------|----------|---------|--------|------|------|-----------|----------|----------|------------|--------------------|----------|
| 安克创新       | 992     | 做多     | -6100   | 1200   | 10   | 12   | -61000    | 12000    | 73000    | 0          | 73         | 完成 |

| 状态 | 交易名称 | 交易类型 | 警告方向 | 距离 | 交易价 | 股数 | 仓位 | 交易金额 | 创建时间 |
|-----|----------|---------|----------|------|--------|------|-----|--------|---------|
| 完成 | 第一手   | 做多     | 向上     | 20   | 1200   | 80  | 120 | 120000 | 2025-09-17 |
| 完成 | 第一手   | 多头平仓 | 向上     | 20   | 1200   | 60   | 10  | 120000 | 2025-09-17 |



#### 可编辑逻辑
- 项目信息：项目名称、项目代号、当前价可直接编辑
- 交易信息：使用与计划页相同的编辑和计算逻辑

### 总览页 (/dashboard)

#### 功能描述
- 显示投资组合的总体统计信息
- 提供关键指标的可视化展示

#### 布局设计
```
┌─────────────────────────────────────────────┐
│                   投资总览                    │
├─────────────────────────────────────────────┤
│ 总金额     │ 成本金额   │ 持仓金额   │ 盈亏金额   │
│  50,000   │   48,000  │   52,000  │   4,000   │
├─────────────────────────────────────────────┤
│ 盈亏率     │ 仓位      │ 更新时间              │
│   8.33%   │   85%     │ 2024-01-15 10:30    │
└─────────────────────────────────────────────┘

[图表区域]
- 盈亏趋势图
- 仓位分布图
- 项目收益对比图
```

### 统计页 (/statistics)
**待开发** - 预留给更高级的分析功能

## 数据计算逻辑

### 项目 (projects)

**前端输入字段**：
* 项目名称
* 项目代号
* 交易类型（做多/做空）
* 当前价
* 创建时间
* 完成时间

**系统计算字段**：
* **成本价** = 成本金额 ÷ 股数 （股数 > 0 时）
* **股数** = ∑(交易股数)
  * 做多、空头平仓：股数加
  * 做空、多头平仓：股数减
* **仓位** = (当前金额 ÷ 自主总金额) × 100 （自主总金额 > 0 时）
* **成本金额** = ∑(交易金额)
  * 做多、空头平仓：金额加
  * 做空、多头平仓：金额减
* **当前金额** = 股数 × 当前价
* **盈亏金额** = 当前金额 - 成本金额
* **项目盈亏率** = (盈亏金额 ÷ 成本金额) × 100 （成本金额 > 0 时）
* **总盈亏率** = (盈亏金额 ÷ 总金额) × 100 （自主总金额 > 0 时）

### 交易 (transactions)

**前端输入字段**：
* 交易名称
* 状态（计划/完成）
* 交易类型
* 警告方向（向上/向下）
* 交易价
* 股数
* 仓位
* 交易金额
* 创建时间
* 交易时间

**系统计算字段**：
* **距离**：
  * 若方向 = 向下： - (交易价 - 项目当前价) ÷ 项目当前价 × 100
  * 若方向 = 向上：   (交易价 - 项目当前价) ÷ 项目当前价 × 100

### 交易页面实时计算逻辑

#### 当修改警告方向时：
```typescript
function updateDistanceOnDirectionChange(direction: '向上' | '向下', 交易价: number, 项目当前价: number) {
  if (direction === '向下') {
    return -((交易价 - 项目当前价) / 项目当前价) * 100;
  } else {
    return ((交易价 - 项目当前价) / 项目当前价) * 100;
  }
}
```

#### 当修改距离时：
```typescript
function updatePriceOnDistanceChange(距离: number, 项目当前价: number, 警告方向: string) {
  const distanceDecimal = 距离 / 100;
  if (警告方向 === '向下') {
    return 项目当前价 * (1 - Math.abs(distanceDecimal));
  } else {
    return 项目当前价 * (1 + distanceDecimal);
  }
}
```

#### 当修改交易价时：
```typescript
function updateOnPriceChange(交易价: number, 项目当前价: number, 警告方向: string) {
  // 更新距离
  const 距离 = updateDistanceOnDirectionChange(警告方向, 交易价, 项目当前价);
  // 可以进一步更新股数（如果需要保持交易金额不变）
  return { 距离 };
}
```

#### 当修改股数时：
```typescript
function updateOnSharesChange(股数: number, 交易价: number, 总金额: number) {
  const 交易金额 = 股数 * 交易价;
  const 仓位 = (交易金额 / 总金额) * 100;
  return { 交易金额, 仓位 };
}
```

#### 当修改仓位时：
```typescript
function updateOnPositionChange(仓位: number, 总金额: number, 交易价: number) {
  const 交易金额 = (仓位 / 100) * 总金额;
  const 股数 = Math.floor(交易金额 / 交易价);
  return { 交易金额, 股数 };
}
```

#### 当修改交易金额时：
```typescript
function updateOnAmountChange(交易金额: number, 交易价: number, 总金额: number) {
  const 股数 = Math.floor(交易金额 / 交易价);
  const 仓位 = (交易金额 / 总金额) * 100;
  return { 股数, 仓位 };
}
```

## 开发阶段

### 阶段1: 基础框架 (1-2天)
1. 创建 Next.js 项目
2. 配置 TailwindCSS + shadcn/ui
3. 设置 SQLite + Better-SQLite3
4. 创建数据库Schema和初始化脚本
5. 实现计算逻辑函数 (lib/calculations.ts)

### 阶段2: 核心API (2-3天)
1. 项目管理 API (CRUD)
2. 交易管理 API (CRUD)
3. 计划页面 API (获取进行中的交易)
4. 总览统计 API
5. 测试API页面（测试所有api，左侧是所有api的按钮和所有能够修改的项的输入框。右侧是api返回结果显示）

### 阶段3: 前端页面 (4-5天)
1. **可编辑组件开发** (1天)
   - InlineEditText: 文本编辑组件
   - InlineEditNumber: 数字编辑组件  
   - InlineEditSelect: 选择编辑组件
   - 实时计算钩子函数

2. **计划页面** (1天)
   - 项目分组显示组件
   - 交易行组件（可编辑）
   - 实时计算集成

3. **项目页面** (1天)
   - 项目信息展示组件（可编辑）
   - 交易列表组件（按状态分组）
   - 项目-交易关联逻辑

4. **总览页面** (1天)
   - 统计卡片组件
   - 基础图表集成
   - 数据刷新机制

5. **导航和布局** (1天)
   - 页面导航组件
   - 响应式布局调整
   - 样式统一化

### 阶段4: 完善和部署 (1-2天)
1. 数据验证和错误处理
2. 加载状态和用户反馈
3. 响应式设计优化
4. Vercel 部署配置
5. 数据备份方案

## 关键技术点

### 1. SQLite 在 Vercel 的处理
```typescript
// lib/db.ts
import Database from 'better-sqlite3';
import path from 'path';

let db: Database.Database | null = null;

export function getDatabase() {
  if (!db) {
    const dbPath = path.join(process.cwd(), 'data', 'investment.db');
    db = new Database(dbPath);
    initializeDatabase(db);
  }
  return db;
}
```

### 2. 实时计算钩子
```typescript
// hooks/useTransactionCalculations.ts
export function useTransactionCalculations(project: Project) {
  const [transaction, setTransaction] = useState<Transaction>();
  
  const updateField = (field: string, value: any) => {
    const updated = { ...transaction };
    
    switch (field) {
      case '警告方向':
        updated.距离 = calculateDistance(updated.交易价, project.当前价, value);
        break;
      case '距离':
        updated.交易价 = calculatePriceFromDistance(value, project.当前价, updated.警告方向);
        break;
      // ... 其他计算逻辑
    }
    
    setTransaction(updated);
  };
  
  return { transaction, updateField };
}
```

### 3. 可编辑组件设计
```typescript
// components/editable/InlineEditNumber.tsx
interface InlineEditNumberProps {
  value: number;
  onChange: (value: number) => void;
  onBlur?: () => void;
  precision?: number;
  suffix?: string;
}

export function InlineEditNumber({ value, onChange, onBlur, precision = 2, suffix }: InlineEditNumberProps) {
  const [editing, setEditing] = useState(false);
  const [tempValue, setTempValue] = useState(value.toString());
  
  // 实现编辑逻辑...
}
```

## 部署注意事项

1. **环境变量**: 最小化配置，主要是数据库路径
2. **构建优化**: 确保SQLite文件正确打包
3. **Edge Runtime**: 利用Vercel Edge功能提升性能
4. **备份策略**: 定期导出数据到JSON或CSV

## 维护建议

1. **代码组织**: 按功能模块划分，单一职责
2. **类型安全**: 使用TypeScript严格模式
3. **错误处理**: API统一错误响应格式
4. **数据验证**: 使用Zod进行输入验证
5. **测试**: 重点测试计算逻辑正确性

## 学习成本评估

* **新手友好**: Next.js + SQLite 学习曲线平缓
* **文档丰富**: 所选技术栈文档完善
* **调试简单**: SQLite 可直接查看，便于调试
* **部署简单**: Vercel 一键部署